<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>インベーダーゲーム - Vanilla JS</title>
  <style>
    :root{
      --bg:#0b1020; --fg:#e6f3ff; --accent:#61dafb; --accent2:#f72585; --good:#2ecc71; --warn:#f39c12;
    }
    html,body{height:100%; margin:0; background:radial-gradient(1200px 600px at 50% 10%, #121a35 0%, var(--bg) 55%, #060912 100%); color:var(--fg); font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", sans-serif}
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between}
    h1{font-size:clamp(18px,2.5vw,22px);letter-spacing:.08em;margin:8px 0}
    .hud{display:flex;gap:10px;align-items:center;font-size:14px;opacity:.9}
    .btn{appearance:none;border:1px solid #223; background:#11182f; color:var(--fg); border-radius:10px; padding:8px 12px; cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .canvas-wrap{position:relative; margin-top:10px; border:1px solid #18223d; border-radius:12px; overflow:hidden; box-shadow:0 8px 36px rgba(0,0,0,.4)}
    canvas{display:block; width:100%; height:auto; background:transparent}
    .overlay{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; text-align:center; padding:20px; backdrop-filter: blur(0px)}
    .panel{background:rgba(9,13,30,.6); border:1px solid #223; border-radius:16px; padding:22px; max-width:520px}
    .panel h2{margin:.2em 0 .6em;font-size:clamp(20px,3.2vw,28px)}
    .panel p{margin:.4em 0; line-height:1.7; opacity:.95}
    .panel .kbd{display:inline-block; padding:2px 6px; border:1px solid #345; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; background:#0c1226}
    .row{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:12px}
    .row .btn{min-width:120px}
    .muted{opacity:.7}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>インベーダーゲーム</h1>
      <div class="hud">
        <button id="pauseBtn" class="btn">⏸︎ 一時停止</button>
        <button id="restartBtn" class="btn">↻ リスタート</button>
      </div>
    </header>

    <div class="canvas-wrap">
      <canvas id="game" width="960" height="540"></canvas>
      <div id="menu" class="overlay">
        <div class="panel">
          <h2>スペースインベーダー（ブラウザ版）</h2>
          <p>キーボードで遊べるクラシック風インベーダー。クリアすると難易度が段階的に上がります。</p>
          <p>
            <span class="kbd">←</span>/<span class="kbd">→</span> または <span class="kbd">A</span>/<span class="kbd">D</span>：移動　
            <span class="kbd">Space</span>：ショット　
            <span class="kbd">P</span>/<span class="kbd">Esc</span>：一時停止
          </p>
          <div class="row">
            <button id="startBtn" class="btn">▶ はじめる</button>
            <button id="howBtn" class="btn">ℹ 遊び方</button>
          </div>
          <p class="muted">© 2025 Invaders.js</p>
        </div>
      </div>
      <div id="how" class="overlay" style="display:none">
        <div class="panel">
          <h2>遊び方</h2>
          <p>画面下の自機を左右に動かし、スペースキーで弾を発射。インベーダーの弾や本体に当たるとライフが減ります。ウェーブを全滅させると次のレベルへ。</p>
          <p>シールドは敵の弾を数回防いでくれます。スコアは命中で +10、列を消すとボーナス、UFO は高得点。</p>
          <div class="row">
            <button id="backBtn" class="btn">← 戻る</button>
          </div>
        </div>
      </div>
      <div id="gameover" class="overlay" style="display:none">
        <div class="panel">
          <h2 id="overTitle">Game Over</h2>
          <p id="overDesc">スコア: <span id="finalScore">0</span>　レベル: <span id="finalLevel">1</span></p>
          <div class="row">
            <button id="againBtn" class="btn">↻ もう一度</button>
            <button id="menuBtn" class="btn">⌂ タイトルへ</button>
          </div>
        </div>
      </div>
    </div>

    <p class="muted" style="margin-top:8px">ヒント：スマホでは横向き推奨。PCだと操作しやすいです。</p>
  </div>

  <script>
  // ===== 基本ユーティリティ =====
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const rand=(a,b)=>Math.random()*(b-a)+a;

  // 画面とスケール
  const canvas=document.getElementById('game');
  const ctx=canvas.getContext('2d');
  function resize(){
    // キャンバスは固定解像度、CSSで伸縮。ここではHD内部解像度のまま描画。
  }
  window.addEventListener('resize', resize); resize();

  // ===== ゲーム状態 =====
  const STATE={ MENU:0, PLAY:1, PAUSE:2, OVER:3, HOW:4 };
  let state=STATE.MENU;

  // 入力
  const keys={left:false,right:false,shoot:false};
  window.addEventListener('keydown',e=>{
    if(['ArrowLeft','a','A'].includes(e.key)) keys.left=true;
    if(['ArrowRight','d','D'].includes(e.key)) keys.right=true;
    if(e.code==='Space'){ keys.shoot=true; e.preventDefault(); }
    if(e.key==='p' || e.key==='P' || e.key==='Escape') togglePause();
  });
  window.addEventListener('keyup',e=>{
    if(['ArrowLeft','a','A'].includes(e.key)) keys.left=false;
    if(['ArrowRight','d','D'].includes(e.key)) keys.right=false;
    if(e.code==='Space') keys.shoot=false;
  });

  // UI要素
  const menuEl=document.getElementById('menu');
  const howEl=document.getElementById('how');
  const overEl=document.getElementById('gameover');
  const startBtn=document.getElementById('startBtn');
  const howBtn=document.getElementById('howBtn');
  const backBtn=document.getElementById('backBtn');
  const againBtn=document.getElementById('againBtn');
  const menuBtn=document.getElementById('menuBtn');
  const pauseBtn=document.getElementById('pauseBtn');
  const restartBtn=document.getElementById('restartBtn');
  const finalScoreEl=document.getElementById('finalScore');
  const finalLevelEl=document.getElementById('finalLevel');

  startBtn.onclick=()=>{ hideAll(); startGame(); };
  howBtn.onclick=()=>{ hideAll(); state=STATE.HOW; howEl.style.display='flex'; };
  backBtn.onclick=()=>{ hideAll(); state=STATE.MENU; menuEl.style.display='flex'; };
  againBtn.onclick=()=>{ hideAll(); startGame(); };
  menuBtn.onclick=()=>{ hideAll(); state=STATE.MENU; menuEl.style.display='flex'; };
  pauseBtn.onclick=()=>togglePause();
  restartBtn.onclick=()=>{ hideAll(); startGame(); };

  function hideAll(){ menuEl.style.display='none'; howEl.style.display='none'; overEl.style.display='none'; }
  function showOver(){ state=STATE.OVER; overEl.style.display='flex'; finalScoreEl.textContent=score|0; finalLevelEl.textContent=level|0; }
  function togglePause(){ if(state===STATE.PLAY){ state=STATE.PAUSE } else if(state===STATE.PAUSE){ state=STATE.PLAY } }

  // ===== エンティティ =====
  class Player{
    constructor(){
      this.w=56; this.h=20; this.x=canvas.width/2-this.w/2; this.y=canvas.height-60; this.spd=360; this.cool=0; this.lives=3;
    }
    update(dt){
      if(keys.left) this.x-=this.spd*dt;
      if(keys.right) this.x+=this.spd*dt;
      this.x=clamp(this.x, 8, canvas.width-this.w-8);
      this.cool=Math.max(0,this.cool-dt);
      if(keys.shoot && this.cool<=0){ this.shoot(); this.cool=0.25; }
    }
    shoot(){
      bullets.push(new Bullet(this.x+this.w/2, this.y-6, -560, '#7cf3ff'));
    }
    draw(){
      ctx.fillStyle='#7cf3ff';
      // シンプルな宇宙船形状
      ctx.fillRect(this.x, this.y+12, this.w, 8);
      ctx.fillRect(this.x+10, this.y+6, this.w-20, 6);
      ctx.fillRect(this.x+22, this.y, this.w-44, 6);
    }
  }

  class Bullet{
    constructor(x,y,vy,color){ this.x=x; this.y=y; this.vy=vy; this.r=3; this.color=color||'#ff6'; this.dead=false; }
    update(dt){ this.y+=this.vy*dt; if(this.y<-10||this.y>canvas.height+10) this.dead=true; }
    draw(){ ctx.fillStyle=this.color; ctx.beginPath(); ctx.arc(this.x,this.y,this.r,0,Math.PI*2); ctx.fill(); }
  }

  class Alien{
    constructor(x,y,row){ this.x=x; this.y=y; this.row=row; this.w=34; this.h=22; this.dead=false; this.cool=rand(0.5,3); }
    update(dt, speedX){ this.x+=speedX*dt; }
    shoot(){ enemyBullets.push(new Bullet(this.x+this.w/2, this.y+this.h+2, 280+level*20, '#f39c12')); }
    draw(t){
      const flick = ((t*6|0)%2)===0;
      ctx.fillStyle=flick? '#f1fa8c':'#ffd166';
      // 8-bit風の矩形描画
      ctx.fillRect(this.x+4, this.y, this.w-8, 6);
      ctx.fillRect(this.x, this.y+6, this.w, 6);
      ctx.fillRect(this.x+4, this.y+12, this.w-8, 6);
    }
  }

  class Shield{
    constructor(x,y){ this.x=x; this.y=y; this.blocks=[]; const rows=4, cols=8, s=8; for(let r=0;r<rows;r++){ for(let c=0;c<cols;c++){ this.blocks.push({x:x+c*s,y:y+r*s,w:s,h:s,hp:2}); } } }
    hit(b){ for(const bl of this.blocks){ if(bl.hp>0 && rectCircle(b, bl)){ bl.hp--; b.dead=true; return true; } } return false; }
    draw(){ for(const bl of this.blocks){ if(bl.hp>0){ ctx.fillStyle = bl.hp===2? '#8bd7ff':'#4fa8d5'; ctx.fillRect(bl.x,bl.y,bl.w,bl.h); } } }
  }

  // ===== ゲームループ関連 =====
  let player, bullets, enemyBullets, aliens, shields, level=1, score=0, dir=1, speed=40, dropY=18, alienTimer=0, ufo=null;

  function startGame(){
    state=STATE.PLAY; level=1; score=0; initLevel(level); }

  function initLevel(lv){
    player=new Player(); bullets=[]; enemyBullets=[]; aliens=[]; ufo=null;
    shields=[ new Shield(160, canvas.height-140), new Shield(canvas.width/2-32, canvas.height-140), new Shield(canvas.width-160-64, canvas.height-140) ];
    const rows=4+Math.min(3, lv); const cols=10; const gapX=12, gapY=18; const startX=80, startY=80;
    for(let r=0;r<rows;r++){ for(let c=0;c<cols;c++){ aliens.push(new Alien(startX+c*(34+gapX), startY+r*(22+gapY), r)); } }
    dir=1; speed=40+lv*8; alienTimer=0;
  }

  function rects(a,b){ return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y; }
  function rectCircle(c, r){
    const cx=clamp(c.x, r.x, r.x+r.w); const cy=clamp(c.y, r.y, r.y+r.h); const dx=c.x-cx, dy=c.y-cy; return (dx*dx+dy*dy) <= (c.r*c.r);
  }

  let last=performance.now();
  function loop(t){
    const now=performance.now(); const dt=Math.min(1/30, (now-last)/1000); last=now;
    if(state===STATE.PLAY) update(dt, now/1000);
    draw(now/1000);
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  function update(dt, t){
    player.update(dt);

    // エイリアン移動
    let minX=1e9, maxX=-1e9, minY=1e9, maxY=-1e9;
    for(const a of aliens){ minX=Math.min(minX,a.x); maxX=Math.max(maxX,a.x+a.w); minY=Math.min(minY,a.y); maxY=Math.max(maxY,a.y+a.h); }
    const outLeft = minX < 10, outRight = maxX > canvas.width-10;
    if(outLeft || outRight){ dir*=-1; for(const a of aliens){ a.y+=dropY; } speed+=8; }
    for(const a of aliens){ a.update(dt, dir*speed); a.cool-=dt; if(a.cool<=0 && Math.random()< (0.008 + level*0.001)){ a.shoot(); a.cool=rand(1.5,3.5); } }

    // プレイヤー弾
    for(const b of bullets) b.update(dt);

    // 敵弾
    for(const eb of enemyBullets) eb.update(dt);

    // 衝突（プレイヤー弾→エイリアン）
    for(const b of bullets){
      if(b.dead) continue;
      for(const a of aliens){ if(!a.dead){
        const rect={x:a.x,y:a.y,w:a.w,h:a.h};
        if(rectCircle(b,rect)){ a.dead=true; b.dead=true; score+=10; break; }
      }}
    }
    aliens=aliens.filter(a=>!a.dead);

    // 衝突（弾→シールド）
    for(const b of bullets){ if(!b.dead) { for(const s of shields){ if(s.hit(b)) break; } } }
    for(const b of enemyBullets){ if(!b.dead) { for(const s of shields){ if(s.hit(b)) break; } } }

    // 衝突（敵弾→プレイヤー）
    const prect={x:player.x,y:player.y,w:player.w,h:player.h};
    for(const eb of enemyBullets){ if(!eb.dead && rectCircle(eb, prect)){ eb.dead=true; player.lives--; if(player.lives<=0){ showOver(); } else { // 無敵短時間とかは簡略
        player.x=canvas.width/2-player.w/2; }
    } }

    // クリーンアップ
    bullets=bullets.filter(b=>!b.dead);
    enemyBullets=enemyBullets.filter(b=>!b.dead);

    // クリア判定
    if(aliens.length===0){ level++; initLevel(level); }
  }

  function draw(t){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // 星背景
    ctx.save();
    for(let i=0;i<120;i++){
      const x=(i*73)%canvas.width; const y=(i*131+ (t*10%canvas.height))%canvas.height; // 流れる星
      ctx.fillStyle= i%9===0? 'rgba(255,255,255,.9)':'rgba(255,255,255,.4)';
      ctx.fillRect(x, y, 1.5, 1.5);
    }
    ctx.restore();

    // HUD
    ctx.fillStyle='rgba(255,255,255,.9)';
    ctx.font='16px ui-monospace, Menlo, monospace';
    ctx.fillText(`SCORE ${score|0}` , 16, 24);
    ctx.fillText(`LEVEL ${level}` , 140, 24);
    ctx.fillText(`LIVES ${player?player.lives:3}` , 240, 24);

    // エンティティ
    if(player) player.draw();
    for(const s of shields) s.draw();
    for(const a of aliens) a.draw(t);
    for(const b of bullets) b.draw();
    for(const eb of enemyBullets) eb.draw();

    if(state===STATE.PAUSE){
      ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle='#fff'; ctx.font='28px system-ui, sans-serif'; ctx.fillText('PAUSED', canvas.width/2-60, canvas.height/2);
    }
  }
  </script>
</body>
</html>
