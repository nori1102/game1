<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>COOL104 – ソリティア（単独プレイ・最高記録対応）</title>
  <style>
    :root { --bg:#0b1020; --panel:#111936; --panel2:#0f1735; --text:#e8ecff; --muted:#9aa6ff; --accent:#6ea8fe; --accent2:#b7d0ff; --good:#60d394; --warn:#ffd166; --card:#f8fafc; --card-text:#0b1020; --shadow:rgba(0,0,0,.25) }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;color:var(--text);background:radial-gradient(1200px 800px at 20% 0%, #111936, #090f20) fixed;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans"}
    header{position:sticky;top:0;z-index:10;display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(180deg,#0e1530,#0b1020);border-bottom:1px solid #1b2858}
    h1{font-size:1.1rem;margin:0;letter-spacing:.02em}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button,select{background:var(--panel);border:1px solid #27366d;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;box-shadow:0 6px 14px var(--shadow) inset;font-size:1rem}
    button.primary{background:linear-gradient(180deg,#2a3f82,#1b2a59);border-color:#3d58a6}
    button:hover{border-color:var(--accent)}
    main{max-width:1100px;margin:16px auto;padding:0 16px 40px}
    .grid{display:grid;grid-template-columns:300px 1fr;gap:20px}
    @media (max-width: 900px){.grid{grid-template-columns:1fr}}

    .side{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #1a285a;border-radius:16px;padding:16px;box-shadow:0 12px 40px var(--shadow)}
    .side h2{margin:8px 0 12px;font-size:1rem;color:#cfe0ff}
    .side .box{background:#0c1330;border:1px solid #1d2a5a;border-radius:12px;padding:12px;margin-bottom:12px}
    .kv{display:grid;grid-template-columns:1fr auto;gap:6px;font-size:.95rem}
    .muted{color:var(--muted);opacity:.9}

    .table{background:linear-gradient(180deg,#0d1432,#0b1128);border:1px solid #162353;border-radius:20px;padding:20px;box-shadow:0 18px 50px var(--shadow);min-height:600px;position:relative}
    .status{display:flex;gap:12px;flex-wrap:wrap;align-items:center;font-size:1rem}
    .pill{padding:8px 12px;border-radius:999px;border:1px solid #2a3b7f;background:#0c1332}
    .pill.good{border-color:#206b4f;color:#a7f3d0}
    .pill.warn{border-color:#7a5a1c;color:#ffe9a6}

    .board{display:grid;grid-template-columns:1fr;gap:16px;margin-top:14px}
    .row{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .slot{min-width:100px;min-height:140px;border:2px dashed #23336d;border-radius:14px;display:grid;place-items:center;padding:8px}

    /* 手札: 1列横スクロール（スマホ崩れを防止） */
    .hand{display:flex;gap:12px;flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;background:linear-gradient(180deg,#0d1536,#0a0f25);border:1px solid #172659;border-radius:16px;padding:12px;margin-top:20px}
    .hand h3{flex:0 0 auto;margin:0 10px 8px 0;font-size:1rem;color:#cfe0ff}

    /* カード（さらに大きめ） */
    .card{flex:0 0 auto;width:110px;height:155px;border-radius:14px;background:var(--card);color:var(--card-text);position:relative;box-shadow:0 6px 14px var(--shadow);user-select:none}
    .card .rank{position:absolute;top:10px;left:10px;font-weight:700;font-size:1.6rem}
    .card .suit{position:absolute;bottom:10px;right:10px;font-size:1.6rem}
    .card.red{color:#b00020}
    .card.back{background:linear-gradient(135deg,#1e2a57,#0f1737);border:2px solid #2d3e82}
    .card.back::after{content:"◆";position:absolute;inset:0;display:grid;place-items:center;color:#9fb6ff;font-size:2.2rem;letter-spacing:.2em}
    .card.playable{outline:4px solid #60d394}
    .card.disabled{opacity:.5;filter:grayscale(.3)}

    .footer{margin-top:20px;font-size:.9rem;color:var(--muted)}
    table.score{width:100%;border-collapse:collapse;font-size:.95rem}
    .score th,.score td{padding:8px 10px;border-bottom:1px solid #1a285a;text-align:left}

    /* 残りカードトラッカー */
    .tracker{display:grid;gap:10px}
    .suitRow{background:#0c1330;border:1px solid #1d2a5a;border-radius:12px;padding:10px}
    .suitHead{display:flex;align-items:center;gap:8px;margin-bottom:8px;font-weight:600;color:var(--accent2)}
    .rgrid{display:grid;grid-template-columns:repeat(13,minmax(22px,1fr));gap:6px}
    .rchip{font-size:.9rem;display:grid;place-items:center;padding:6px 0;border-radius:8px;border:1px solid #27366d;background:#0e1736;color:#cfe0ff}
    .rchip.zero{opacity:.35;color:#8aa0ff;border-style:dashed}
    .rchip.full{background:#0d224a}

    @media (max-width:520px){
      .card{width:95px;height:135px}
      .card .rank,.card .suit{font-size:1.4rem}
      .rgrid{grid-template-columns:repeat(13,26px)}
    }
  </style>
</head>
<body>
  <header>
    <h1>COOL104（ソリティア）— 絵柄または番号で重ねる一人用</h1>
    <div class="controls">
      <button id="newGame" class="primary">新しく始める</button>
      <button id="hintBtn" title="出せるカードをハイライト">ヒント</button>
      <select id="deckMode">
        <option value="1" selected>1デッキ（52枚）</option>
        <option value="2">2デッキ連続（104枚目標）</option>
      </select>
    </div>
  </header>

  <main>
    <div class="grid">
      <aside class="side">
        <div class="box">
          <h2>ルール（Wikipedia準拠）</h2>
          <ul style="margin:6px 0 0 18px;line-height:1.6">
            <li>手札は常に<strong>5枚</strong>。最初の1枚は好きなカードを<strong>台札</strong>として出す。</li>
            <li>以後、<strong>台札の一番上</strong>と<strong>同じ絵柄</strong>または<strong>同じ番号</strong>のみ出せる。</li>
            <li>カードを1枚出すたび、山札から1枚<strong>補充</strong>（手札は常に5枚、山札が尽きるまで）。</li>
            <li>出せなくなった時点で<strong>終了</strong>。何枚出せたかがスコア。</li>
            <li>1デッキ52枚を出し切れたら<strong>クリア</strong>。選択が2デッキなら続けて<strong>104枚</strong>まで挑戦可。</li>
          </ul>
        </div>
        <div class="box">
          <h2>スコア / 状態</h2>
          <table class="score">
            <tbody>
              <tr><th>出した枚数</th><td id="scorePlayed">0</td></tr>
              <tr><th>残り山札</th><td id="scoreStock">0</td></tr>
              <tr><th>現在デッキ</th><td id="scoreDeck">1 / 1</td></tr>
            </tbody>
          </table>
        </div>
        <div class="box">
          <h2>残りカード（場に未登場）</h2>
          <div id="tracker" class="tracker"></div>
        </div>
        <div class="box">
          <h2>最高記録</h2>
          <table class="score" id="hiscoreTbl">
            <tbody>
              <tr><th>最大到達枚数</th><td id="hsBestPlayed">-</td></tr>
              <tr><th>クリア最速（52枚）</th><td id="hsBestTime52">-</td></tr>
              <tr><th>クリア最速（104枚）</th><td id="hsBestTime104">-</td></tr>
              <tr><th>通算プレイ</th><td id="hsTotal">-</td></tr>
            </tbody>
          </table>
          <button id="resetHS" class="ghost" style="margin-top:8px">記録をリセット</button>
        </div>
      </aside>

      <section class="table">
        <div class="status">
          <span class="pill" id="statePill">状態: 準備中</span>
          <span class="pill" id="topPill">台札: -</span>
          <span class="pill" id="tipsPill">ヒント: -</span>
        </div>

        <div class="board">
          <div class="row">
            <div class="slot" id="stockSlot" title="山札"><div class="card back" aria-label="stock"></div></div>
            <div class="slot" id="wasteSlot" title="台札（出したカードの山）"></div>
          </div>
        </div>

        <div class="hand" id="hand"><h3>あなたの手札</h3></div>
        <div class="footer">© COOL104 solitaire – 単一HTML。GitHub Pages に index.html として置くだけで動作します。</div>
      </section>
    </div>
  </main>

  <script>
    const SUITS = ["♠","♥","♦","♣"]; const RANKS = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];  
    const $ = s=>document.querySelector(s); const $$ = s=>[...document.querySelectorAll(s)];
    const isRed = s=> s==="♥"||s==="♦";
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]] } return a }
    function makeDeck(){ const d=[]; for(const s of SUITS){ for(const r of RANKS){ d.push({suit:s,rank:r}); } } return d }

    const st = { deckMode:1, deckIndex:1, stock:[], waste:[], hand:[], playedCount:0, over:false, startAt:0 }

    function canPlayOn(top, card){ if(!top) return true; return top.suit===card.suit || top.rank===card.rank }
    function playableCards(){ const top = st.waste[st.waste.length-1]; return st.hand.filter(c=>canPlayOn(top,c)) }

    const placedCounts = {}; for(const s of SUITS){ placedCounts[s] = {}; for(const r of RANKS){ placedCounts[s][r] = 0 } }
    function bumpPlaced(card){ placedCounts[card.suit][card.rank] += 1 }
    function renderTracker(){
      const wrap = $("#tracker"); wrap.innerHTML = "";
      const maxPerRank = st.deckMode===2 ? 2 : 1;
      for(const suit of SUITS){
        const box=document.createElement('div'); box.className='suitRow';
        const head=document.createElement('div'); head.className='suitHead'; head.textContent=`${suit} の残り（未登場）`; box.appendChild(head);
        const grid=document.createElement('div'); grid.className='rgrid';
        for(const r of RANKS){ const placed=placedCounts[suit][r]; const remain=Math.max(0, maxPerRank - placed); const chip=document.createElement('div'); chip.className='rchip'; if(remain===0) chip.classList.add('zero'); if(remain===maxPerRank) chip.classList.add('full'); chip.title=`${suit}${r}: 場に ${placed} / 残り ${remain}`; chip.textContent = r==='10' ? '10' : r[0]; grid.appendChild(chip); }
        box.appendChild(grid); wrap.appendChild(box);
      }
    }

    function renderAll(){
      const top = st.waste[st.waste.length-1];
      $("#topPill").textContent = `台札: ${top?top.suit+top.rank:"-"}`;
      $("#scorePlayed").textContent = String(st.playedCount);
      $("#scoreStock").textContent = String(st.stock.length);
      $("#scoreDeck").textContent = `${st.deckIndex} / ${st.deckMode}`;

      const handEl = $("#hand");
      handEl.innerHTML = '<h3>あなたの手札</h3>';
      const playable = playableCards().map(x=>JSON.stringify(x));
      for(const c of st.hand.slice()){
        const el = cardView(c);
        if(st.over) el.classList.add('disabled');
        if(playable.includes(JSON.stringify(c))) el.classList.add('playable');
        el.onclick = ()=>{ if(st.over) return; const topNow = st.waste[st.waste.length-1]; if(!canPlayOn(topNow, c)) return; playCard(c); }
        handEl.appendChild(el);
      }

      const waste = $("#wasteSlot"); waste.innerHTML = ""; if(top){ waste.appendChild(cardView(top)); }

      $("#tipsPill").textContent = playable.length? `出せるカード: ${playableCards().map(c=>c.suit+c.rank).join(' ')}` : '出せるカードなし';
      $("#statePill").textContent = st.over ? '状態: 終了' : '状態: プレイ中';

      renderTracker(); renderHighScore();
    }

    function cardView(c){
      const el = document.createElement('div');
      el.className = 'card' + (isRed(c.suit)?' red':'');
      const r=document.createElement('div'); r.className='rank'; r.textContent = c.rank; el.appendChild(r);
      const s=document.createElement('div'); s.className='suit'; s.textContent = c.suit; el.appendChild(s);
      el.setAttribute('aria-label', `${c.suit}${c.rank}`);
      return el;
    }

    function startGame(){
      st.deckIndex=1; st.playedCount=0; st.over=false; st.waste=[]; st.hand=[];
