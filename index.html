<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>COOL104 – シングルプレイ実装（index.html）</title>
  <style>
    :root {
      --bg:#0b1020; --panel:#111936; --panel2:#0f1735; --text:#e8ecff;
      --muted:#9aa6ff; --accent:#6ea8fe; --good:#60d394; --warn:#ffd166; --bad:#ff6b6b;
      --card:#f8fafc; --card-text:#0b1020; --shadow: rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;color:var(--text);background:radial-gradient(1200px 800px at 20% 0%, #111936, #090f20) fixed;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans"}
    header{position:sticky;top:0;z-index:10;display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(180deg,#0e1530,#0b1020);border-bottom:1px solid #1b2858}
    h1{font-size:1.05rem;margin:0;letter-spacing:.02em}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button,select{background:var(--panel);border:1px solid #27366d;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;box-shadow:0 6px 14px var(--shadow) inset}
    button.primary{background:linear-gradient(180deg,#2a3f82,#1b2a59);border-color:#3d58a6}
    button:hover{border-color:var(--accent)}
    main{max-width:1100px;margin:16px auto;padding:0 16px 40px}
    .grid{display:grid;grid-template-columns:280px 1fr;gap:16px}
    @media (max-width: 900px){.grid{grid-template-columns:1fr}}

    .side{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #1a285a;border-radius:16px;padding:14px;box-shadow:0 12px 40px var(--shadow)}
    .side h2{margin:6px 0 10px;font-size:.95rem;color:#cfe0ff}
    .side .box{background:#0c1330;border:1px solid #1d2a5a;border-radius:12px;padding:10px;margin-bottom:10px}
    .kv{display:grid;grid-template-columns:1fr auto;gap:6px;font-size:.9rem}
    .muted{color:var(--muted);opacity:.9}

    .table{background:linear-gradient(180deg,#0d1432,#0b1128);border:1px solid #162353;border-radius:18px;padding:16px;box-shadow:0 18px 50px var(--shadow);min-height:560px;position:relative}
    .status{display:flex;gap:10px;flex-wrap:wrap;align-items:center;font-size:.95rem}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid #2a3b7f;background:#0c1332}
    .pill.good{border-color:#206b4f;color:#a7f3d0}
    .pill.warn{border-color:#7a5a1c;color:#ffe9a6}

    .board{display:grid;grid-template-columns:1fr;gap:12px;margin-top:10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .slot{min-width:70px;min-height:100px;border:1px dashed #23336d;border-radius:12px;display:grid;place-items:center;padding:6px}
    .pile{display:flex;gap:8px;align-items:center}

    .card{width:62px;height:86px;border-radius:10px;background:var(--card);color:var(--card-text);position:relative;box-shadow:0 4px 10px var(--shadow);user-select:none}
    .card .rank{position:absolute;top:6px;left:6px;font-weight:700;font-size:.9rem}
    .card .suit{position:absolute;bottom:6px;right:6px;font-size:.9rem}
    .card.red{color:#b00020}
    .card.back{background:linear-gradient(135deg,#1e2a57,#0f1737);border:1px solid #2d3e82}
    .card.back::after{content:"◆";position:absolute;inset:0;display:grid;place-items:center;color:#9fb6ff;font-size:1.2rem;letter-spacing:.2em}
    .card.playable{outline:3px solid #60d394}
    .card.disabled{opacity:.5;filter:grayscale(.3)}

    .hand{display:flex;gap:8px;flex-wrap:wrap;background:linear-gradient(180deg,#0d1536,#0a0f25);border:1px solid #172659;border-radius:14px;padding:10px;margin-top:16px}
    .hand h3{width:100%;margin:0 0 6px;font-size:.9rem;color:#cfe0ff}

    .footer{margin-top:18px;font-size:.85rem;color:var(--muted)}
    table.score{width:100%;border-collapse:collapse;font-size:.9rem}
    .score th,.score td{padding:6px 8px;border-bottom:1px solid #1a285a;text-align:left}
  </style>
</head>
<body>
  <header>
    <h1>COOL104（ソリティア）— 同スート or 同ランクで重ねる一人用</h1>
    <div class="controls">
      <button id="newGame" class="primary">新しく始める</button>
      <button id="hintBtn" title="出せるカードをハイライト">ヒント</button>
      <select id="deckMode">
        <option value="1">1デッキ（52枚）</option>
        <option value="2" selected>2デッキ連続（104枚目標）</option>
      </select>
    </div>
  </header>

  <main>
    <div class="grid">
      <aside class="side">
        <div class="box">
          <h2>ルール（Wikipedia準拠の簡易実装）</h2>
          <ul style="margin:6px 0 0 18px;line-height:1.6">
            <li>手札は常に<strong>5枚</strong>。最初の1枚は好きなカードを<strong>台札</strong>として出す。</li>
            <li>以後、<strong>台札の一番上</strong>と<strong>同じスート</strong>または<strong>同じランク</strong>のみ出せる。</li>
            <li>カードを1枚出すたび、山札から1枚<strong>補充</strong>して手札は5枚に戻る（山札が尽きるまで）。</li>
            <li>出せなくなった時点で<strong>終了</strong>。何枚出せたかがスコア。</li>
            <li>1デッキ52枚を出し切れたら<strong>クリア</strong>。続けて2デッキ目まで行ければ<strong>104枚</strong>達成。</li>
            <li>手札5枚がポーカー役を満たすと<strong>ボーナス点</strong>（演出のみ）。</li>
          </ul>
        </div>
        <div class="box">
          <h2>スコア</h2>
          <table class="score" id="scoreTbl">
            <tbody>
              <tr><th>出した枚数</th><td id="scorePlayed">0</td></tr>
              <tr><th>残り山札</th><td id="scoreStock">0</td></tr>
              <tr><th>現在デッキ</th><td id="scoreDeck">1 / 2</td></tr>
              <tr><th>ポーカー役</th><td id="scorePoker">-</td></tr>
            </tbody>
          </table>
        </div>
        <div class="box">
          <h2>ヒント</h2>
          <div class="kv"><span class="muted">クリック</span><span>→ 出せるカードを自動判定</span></div>
          <div class="kv"><span class="muted">ヒント</span><span>→ 今出せるカードを緑の枠で表示</span></div>
          <div class="kv"><span class="muted">2デッキ</span><span>→ 52枚達成後、続けて山札を新規セット</span></div>
        </div>
      </aside>

      <section class="table">
        <div class="status">
          <span class="pill" id="statePill">状態: 準備中</span>
          <span class="pill" id="topPill">台札: -</span>
          <span class="pill" id="tipsPill">ヒント: -</span>
        </div>

        <div class="board">
          <div class="row">
            <div class="pile">
              <div class="slot" id="stockSlot" title="山札"><div class="card back" aria-label="stock"></div></div>
              <div class="slot" id="wasteSlot" title="台札（出したカードの山）"></div>
            </div>
          </div>
        </div>

        <div class="hand" id="hand"><h3>あなたの手札</h3></div>
        <div class="footer">© COOL104 demo – 単一ファイル。GitHub Pages に index.html として置くだけで動作します。</div>
      </section>
    </div>
  </main>

  <script>
    // ===== ユーティリティ
    const SUITS = ["♠","♥","♦","♣"]; const RANKS = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];  
    const R2N = Object.fromEntries(RANKS.map((r,i)=>[r,i+1]));
    const $ = s=>document.querySelector(s); const $$ = s=>[...document.querySelectorAll(s)];
    const isRed = s=> s==="♥"||s==="♦";
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]] } return a }
    function makeDeck(){ const d=[]; for(const s of SUITS){ for(const r of RANKS){ d.push({suit:s,rank:r}); } } return d }

    // ===== ゲーム状態
    const st = {
      deckMode: 2, // 1=52, 2=104（連続）
      deckIndex: 1, // 現在のデッキ番号
      stock: [], // 残り山札
      waste: [], // 台札（出したカードの山）
      hand: [],  // 手札 5
      playedCount: 0,
      over: false,
    }

    // ===== ルール判定
    function canPlayOn(top, card){ if(!top) return true; return top.suit===card.suit || top.rank===card.rank }
    function playableCards(){ const top = st.waste[st.waste.length-1]; return st.hand.filter(c=>canPlayOn(top,c)) }

    // ===== ポーカー役（簡易）
    function evaluatePoker5(cards){
      if(cards.length<5) return null;
      const ranks = cards.map(c=>R2N[c.rank]).sort((a,b)=>a-b);
      const suits = cards.map(c=>c.suit);
      const counts = new Map(); for(const r of ranks){ counts.set(r,(counts.get(r)||0)+1) }
      const isFlush = new Set(suits).size===1;
      const isStraight = (()=>{ const r=[...new Set(ranks)]; if(r.length!==5) return false; // A,10,J,Q,K は 10-11-12-13-1 を許容しない簡易
        for(let i=1;i<5;i++){ if(r[i]!==r[0]+i) return false } return true })();
      const vals=[...counts.values()].sort((a,b)=>b-a).join("");
      if(isStraight && isFlush && ranks[0]===10) return "ロイヤルフラッシュ"; // 10,J,Q,K,A のみ
      if(isStraight && isFlush) return "ストレートフラッシュ";
      if(vals==="41") return "フォーカード";
      if(vals==="32") return "フルハウス";
      if(isFlush) return "フラッシュ";
      if(isStraight) return "ストレート";
      return null;
    }

    // ===== 描画
    function renderAll(){
      const top = st.waste[st.waste.length-1];
      document.querySelector('#topPill').textContent = `台札: ${top?top.suit+top.rank:"-"}`;
      document.querySelector('#scorePlayed').textContent = String(st.playedCount);
      document.querySelector('#scoreStock').textContent = String(st.stock.length);
      document.querySelector('#scoreDeck').textContent = `${st.deckIndex} / ${st.deckMode}`;

      const handEl = document.querySelector('#hand');
      handEl.innerHTML = '<h3>あなたの手札</h3>';
      const playable = playableCards().map(x=>JSON.stringify(x));
      for(const c of st.hand.slice()){
        const el = cardView(c);
        if(st.over) el.classList.add('disabled');
        if(playable.includes(JSON.stringify(c))) el.classList.add('playable');
        el.onclick = ()=>{
          if(st.over) return;
          if(!canPlayOn(top, c)) return;
          playCard(c);
        }
        handEl.appendChild(el);
      }

      const waste = document.querySelector('#wasteSlot');
      waste.innerHTML = "";
      if(top){ waste.appendChild(cardView(top)); }

      document.querySelector('#tipsPill').textContent = playable.length? `出せるカード: ${playableCards().map(c=>c.suit+c.rank).join(' ')}` : '出せるカードなし';
      document.querySelector('#statePill').textContent = st.over ? '状態: 終了' : '状態: プレイ中';

      const poker = evaluatePoker5(st.hand);
      document.querySelector('#scorePoker').textContent = poker || '-';
    }

    function cardView(c){
      const el = document.createElement('div');
      el.className = 'card' + (isRed(c.suit)?' red':'');
      const r=document.createElement('div'); r.className='rank'; r.textContent = c.rank; el.appendChild(r);
      const s=document.createElement('div'); s.className='suit'; s.textContent = c.suit; el.appendChild(s);
      el.setAttribute('aria-label', `${c.suit}${c.rank}`);
      return el;
    }

    // ===== ロジック
    function startGame(){
      st.deckIndex = 1; st.playedCount = 0; st.over = false; st.waste = []; st.hand = []; st.stock = [];
      const d1 = shuffle(makeDeck());
      st.stock = d1;
      dealTo5();
      renderAll();
      document.querySelector('#statePill').textContent = '状態: 最初の1枚を出してください（何でも可）';
    }

    function nextDeckIfNeeded(){
      if(st.deckMode===2 && st.stock.length===0 && st.hand.length>0 && st.playedCount>=52 && st.deckIndex===1){
        st.deckIndex = 2;
        st.stock = shuffle(makeDeck());
      }
    }

    function dealTo5(){
      while(st.hand.length<5 && st.stock.length){ st.hand.push(st.stock.pop()); }
    }

    function playCard(card){
      const i = st.hand.findIndex(x=>x.suit===card.suit && x.rank===card.rank);
      if(i<0) return;
      const taken = st.hand.splice(i,1)[0];
      st.waste.push(taken);
      st.playedCount++;
      nextDeckIfNeeded();
      dealTo5();

      const canMore = st.hand.some(h=>canPlayOn(st.waste[st.waste.length-1], h));
      if(!canMore) st.over = true;
      renderAll();
    }

    document.querySelector('#newGame').addEventListener('click', startGame);
    document.querySelector('#hintBtn').addEventListener('click', ()=>{
      const pc = playableCards();
      if(!pc.length) return;
      const labels = new Set(pc.map(c=>c.suit+c.rank));
      document.querySelectorAll('.hand .card').forEach(el=>{
        const lab = el.getAttribute('aria-label').replace(/\s/g,'');
        if(labels.has(lab)) el.classList.add('playable');
      });
    });
    document.querySelector('#deckMode').addEventListener('change', e=>{ st.deckMode = Number(e.target.value); startGame(); });

    startGame();
  </script>
</body>
</html>
