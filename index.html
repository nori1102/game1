<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>間違い探し（3か所固定・WEBランダム）</title>
<style>
  :root{
    --bg:#0b1020; --fg:#e6f3ff; --line:#22314f;
    --good:#23d18b; --bad:#ff4d6d;
  }
  html,body{margin:0;background:radial-gradient(1200px 600px at 50% 5%, #151d3f 0%, #0b1020 55%, #070a14 100%);
    color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif}
  .wrap{max-width:1280px;margin:0 auto;padding:14px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  h1{font-size:clamp(18px,3vw,24px);letter-spacing:.06em;margin:6px 0}
  .btn{appearance:none;border:1px solid var(--line);background:#0e1836;color:var(--fg);
    border-radius:12px;padding:10px 16px;cursor:pointer;font-weight:600}
  .btn:hover{filter:brightness(1.08)}
  .pill{padding:6px 12px;border:1px solid var(--line);border-radius:999px;background:#0e1533;font-variant-numeric:tabular-nums}
  .boards{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  .board{position:relative;border:1px solid var(--line);border-radius:14px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.45);background:#0a122b}
  canvas{display:block;width:100%;height:auto}
  .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;text-align:center;background:rgba(0,0,0,.45)}
  .card{background:rgba(8,12,28,.85);border:1px solid var(--line);border-radius:16px;padding:22px 20px;max-width:560px}
  footer{opacity:.75;font-size:12px;margin-top:10px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>間違い探し（3か所固定・WEBランダム）</h1>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <button id="startBtn" class="btn">▶ スタート</button>
      <span class="pill">残り: <b id="remain">-</b></span>
      <span class="pill">タイム: <b id="time">00:00</b></span>
    </div>
  </header>

  <div class="boards">
    <div class="board">
      <canvas id="canL"></canvas>
    </div>
    <div class="board">
      <canvas id="canR"></canvas>
      <div id="menu" class="overlay">
        <div class="card">
          <h2>遊び方</h2>
          <p>スタートを押すと、WEBからランダムに高精細画像を取得して左右に表示します。右の画像には<b>常に3か所</b>だけ細かな違いを仕込みます。見つけたらタップ/クリック！</p>
          <p style="opacity:.85">※ 画像は Wikimedia Commons から取得します（CORS対応）。</p>
          <button id="startBig" class="btn">▶ スタート</button>
        </div>
      </div>
    </div>
  </div>

  <footer>© 2025 SpotDiff — 3 differences / Random web image / Client-only</footer>
</div>

<script>
(function(){
  const canL = document.getElementById('canL');
  const canR = document.getElementById('canR');
  const ctxL = canL.getContext('2d');
  const ctxR = canR.getContext('2d');
  const startBtn = document.getElementById('startBtn');
  const startBig = document.getElementById('startBig');
  const menu = document.getElementById('menu');
  const remainEl = document.getElementById('remain');
  const timeEl = document.getElementById('time');

  // 固定：常に3か所
  const DIFF_COUNT = 3;

  // 状態
  let img = new Image();
  let diffs = []; // {x,y,r,found:false} 右画像の座標系（実ピクセル）
  let found = 0;
  let timerId = null, tStart = 0;

  // タイマー
  function fmtTime(ms){ const s=Math.floor(ms/1000); const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`; }
  function startTimer(){ clearInterval(timerId); tStart=performance.now(); timerId=setInterval(()=>timeEl.textContent=fmtTime(performance.now()-tStart),250); }
  function stopTimer(){ clearInterval(timerId); }

  // 描画（高精細対応）
  function drawFit(img, canvas, ctx){
    const dpr = Math.min(window.devicePixelRatio || 1, 2);
    // レイアウト：最大640px表示、内部は原寸×dpr
    canvas.style.width = Math.min(640, img.naturalWidth) + 'px';
    const scale = img.naturalWidth / img.naturalHeight;
    const cssW = canvas.clientWidth || Math.min(640, img.naturalWidth);
    const cssH = Math.round(cssW / scale);
    canvas.style.height = cssH + 'px';
    canvas.width = Math.round(img.naturalWidth * dpr);
    canvas.height = Math.round(img.naturalHeight * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,canvas.width/dpr,canvas.height/dpr);
    ctx.drawImage(img, 0, 0);
  }

  // WEBからランダム画像取得（Wikimedia Commons / CORS）
  async function fetchRandomImage(){
    const api='https://commons.wikimedia.org/w/api.php';
    const url=`${api}?action=query&generator=random&grnnamespace=6&grnlimit=1&prop=imageinfo&iiprop=url|mime|size&iiurlwidth=3000&format=json&origin=*`;
    const res=await fetch(url);
    const data=await res.json();
    const page = data?.query?.pages && Object.values(data.query.pages)[0];
    const info = page?.imageinfo?.[0];
    if(!info?.url) throw new Error('画像取得に失敗');
    return info.url;
  }

  // 差分を右画像に「埋め込む」（元画像を軽く加工：明度・色相シフトなど）
  function implantDifferences(){
    diffs = [];
    // 右キャンバスの生解像度（dpr考慮前）を取得
    const dpr = Math.min(window.devicePixelRatio||1,2);
    const w = Math.round(canR.width / dpr);
    const h = Math.round(canR.height / dpr);

    // 3つのランダム円を作る（縁から余白を取る）
    const RMIN=18, RMAX=36, MARGIN=40;
    for(let i=0;i<DIFF_COUNT;i++){
      const r = Math.floor(RMIN + Math.random()*(RMAX-RMIN));
      const x = Math.floor(MARGIN + Math.random()*(w - MARGIN*2));
      const y = Math.floor(MARGIN + Math.random()*(h - MARGIN*2));
      diffs.push({x, y, r, found:false});
    }

    // ピクセル加工：円領域内の彩度/明度を変えて「自然な違い」を作る
    // 右キャンバスはすでに drawFit 済みなので、その上のピクセルを取得・変換
    const imgData = ctxR.getImageData(0,0,w,h);
    const arr = imgData.data;

    function inCircle(cx,cy,cr,px,py){ const dx=px-cx, dy=py-cy; return dx*dx+dy*dy<=cr*cr; }
    function rgb2hsl(r,g,b){
      r/=255; g/=255; b/=255;
      const max=Math.max(r,g,b), min=Math.min(r,g,b);
      let h,s,l=(max+min)/2;
      if(max===min){ h=s=0; }
      else{
        const d=max-min;
        s = l>0.5 ? d/(2-max-min) : d/(max+min);
        switch(max){
          case r: h=(g-b)/d + (g<b?6:0); break;
          case g: h=(b-r)/d + 2; break;
          case b: h=(r-g)/d + 4; break;
        }
        h/=6;
      }
      return [h,s,l];
    }
    function hsl2rgb(h,s,l){
      function hue2rgb(p,q,t){ if(t<0) t+=1; if(t>1) t-=1;
        if(t<1/6) return p+(q-p)*6*t;
        if(t<1/2) return q;
        if(t<2/3) return p+(q-p)*(2/3 - t)*6;
        return p;
      }
      let r,g,b;
      if(s===0){ r=g=b=l; }
      else{
        const q = l<0.5 ? l*(1+s) : l+s - l*s;
        const p = 2*l - q;
        r = hue2rgb(p,q,h+1/3);
        g = hue2rgb(p,q,h);
        b = hue2rgb(p,q,h-1/3);
      }
      return [Math.round(r*255),Math.round(g*255),Math.round(b*255)];
    }

    // 各円ごとに微妙に異なる加工（色相±、明度±）
    diffs.forEach((d,idx)=>{
      const hueShift = ((idx+1)*0.08) * (Math.random()<0.5?-1:1); // ±約0.08（約±30°）
      const lightDelta = (Math.random()*0.20 - 0.10); // -0.10〜+0.10
      for(let py=d.y-d.r; py<=d.y+d.r; py++){
        if(py<0||py>=h) continue;
        for(let px=d.x-d.r; px<=d.x+d.r; px++){
          if(px<0||px>=w) continue;
          if(!inCircle(d.x,d.y,d.r,px,py)) continue;
          const i=(py*w+px)*4;
          const r=arr[i], g=arr[i+1], b=arr[i+2];
          let [hh,ss,ll]=rgb2hsl(r,g,b);
          hh = (hh + hueShift + 1)%1;
          ll = Math.max(0, Math.min(1, ll + lightDelta));
          const [nr,ng,nb]=hsl2rgb(hh,ss,ll);
          arr[i]=nr; arr[i+1]=ng; arr[i+2]=nb; // alphaはそのまま
        }
      }
    });

    ctxR.putImageData(imgData, 0, 0);
    found = 0;
    remainEl.textContent = (DIFF_COUNT - found);
    startTimer();
  }

  // スタート：画像を取得→左右に描画→右に3か所の違いを埋め込む
  async function startGame(){
    menu.style.display='none';
    remainEl.textContent='-'; timeEl.textContent='00:00'; stopTimer();
    try{
      const src = await fetchRandomImage();
      img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = ()=>{
        drawFit(img, canL, ctxL);
        drawFit(img, canR, ctxR);
        // 右だけ加工して違いを作成
        implantDifferences();
      };
      img.src = src;
    }catch(e){
      console.error(e);
      alert('画像の取得に失敗しました。もう一度お試しください。');
      menu.style.display='flex';
    }
  }

  // クリック判定（右だけ）
  function flash(x,y,r,kind){
    ctxR.save();
    ctxR.lineWidth=4;
    ctxR.strokeStyle = (kind==='good')? 'var(--good)' : 'var(--bad)';
    ctxR.beginPath(); ctxR.arc(x,y,r+5,0,Math.PI*2); ctxR.stroke();
    ctxR.restore();
  }

  function checkHit(px,py){
    for(const d of diffs){
      if(!d.found && Math.hypot(px-d.x, py-d.y)<=d.r){
        d.found = true; found++;
        flash(d.x,d.y,d.r,'good');
        remainEl.textContent = (DIFF_COUNT - found);
        if(found===DIFF_COUNT){ stopTimer(); setTimeout(()=>alert('クリア！'),10); }
        return;
      }
    }
    flash(px,py,14,'bad');
  }

  canR.addEventListener('click',(e)=>{
    // CSSサイズ→キャンバス座標に変換
    const r=canR.getBoundingClientRect();
    const dpr=Math.min(window.devicePixelRatio||1,2);
    const scaleX=canR.width/dpr/r.width, scaleY=canR.height/dpr/r.height;
    const x=(e.clientX-r.left)*scaleX, y=(e.clientY-r.top)*scaleY;
    checkHit(x,y);
  },{passive:true});

  // ボタン
  startBtn.onclick = startGame;
  startBig.onclick = startGame;

  // 初期はガイド表示
  menu.style.display='flex';
})();
</script>
</body>
</html>
